{% extends 'base.html.twig' %}

{% block title %}Mon Espace Client - WorkTogether{% endblock %}

{% block body %}
    <div class="container mt-5">
        <h1 class="mb-4">Bienvenue dans votre Espace Client</h1>

        <div class="row">
            {# --- COLONNE GAUCHE : INFOS & COMMANDES --- #}
            <div class="col-md-4">
                {# Gestion des données personnelles #}
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Mes Informations</h5>
                    </div>
                    <div class="card-body">
                        {# On utilise les vraies données de app.user #}
                        <p><strong>Nom :</strong> {{ app.user.firstName|capitalize }} {{ app.user.lastName|upper }}</p>
                        <p><strong>Email :</strong> {{ app.user.email }}</p>
                        <hr>
                        <a href="#" class="btn btn-sm btn-outline-primary w-100 mb-2">Modifier mon profil</a>
                        <a href="#" class="btn btn-sm btn-outline-secondary w-100">Changer mon mot de passe</a>
                    </div>
                </div>

                {# Gestion des commandes (Locations / Rentals) #}
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Mes Commandes</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush">
                            {# Boucle sur les locations du client #}
                            {% for rental in rentals %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {# On remonte au label de l'offre et au nombre d'unités #}
                                    Pack {{ rental.offer.label }} ({{ rental.offer.unitsNumber }}U)
                                    <span class="badge bg-success rounded-pill">Actif</span>
                                </li>
                            {% else %}
                                <li class="list-group-item text-muted text-center small">
                                    Aucune location en cours.
                                </li>
                            {% endfor %}
                        </ul>
                        <div class="p-3">
                            <a href="{{ path('app_home') }}#offres" class="btn btn-warning btn-sm w-100">Nouvelle commande</a>
                        </div>
                    </div>
                </div>
            </div>

            {# --- COLONNE DROITE : GESTION DES UNITÉS & ÉTAT --- #}
            <div class="col-md-8">
                {# Visualisation de l'emplacement et état #}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Mes Unités dans le Datacenter</h5>
                        <span class="badge bg-light text-dark">Total : {{ units|length }} Unités</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>Emplacement</th>
                                    <th>Taille</th>
                                    <th>État</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {# Boucle sur les unités du client #}
                                {% for unit in units %}
                                    <tr>
                                        {# On affiche la baie puis l'unité (Ex: B014 - U06) #}
                                        <td><strong>{{ unit.bay.label }} - {{ unit.label }}</strong></td>
                                        <td>
                                            <span class="badge bg-dark">{{ unit.size }} U</span>
                                        </td>
                                        <td>
                                            {# Affichage conditionnel selon l'état de l'unité #}
                                            {% if unit.state.label == 'OK' %}
                                                <span class="text-success">● {{ unit.state.label }}</span>
                                            {% elseif unit.state.label == 'Incident' %}
                                                <span class="text-danger fw-bold">● {{ unit.state.label }}</span>
                                            {% else %}
                                                <span class="text-warning">● {{ unit.state.label }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if unit.state.label == 'Incident' %}
                                                <a href="#" class="btn btn-sm btn-outline-danger">Détails Incident</a>
                                            {% else %}
                                                <button class="btn btn-sm btn-light border">Configurer</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-3">
                                            Vous n'avez pas encore d'unités attribuées.
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {# Historique des interventions liées aux unités du client #}
                <div>
                    <h6>Historique récent des interventions</h6>
                    {% set hasInterventions = false %}
                    
                    {# On boucle sur les unités, puis sur leurs interventions #}
                    {% for unit in units %}
                        {% for intervention in unit.interventions %}
                            {% set hasInterventions = true %}
                            <div class="alert alert-info py-2 small mb-2">
                                <strong>{{ intervention.startDate|date('d/m/Y H:i') }} :</strong> 
                                {{ intervention.description|default('Intervention technique en cours') }} sur {{ unit.bay.label }}-{{ unit.label }}.
                                (Technicien: {{ intervention.technician.label|default('Non assigné') }})
                            </div>
                        {% endfor %}
                    {% endfor %}

                    {% if not hasInterventions %}
                        <p class="text-muted small">Aucune intervention enregistrée sur vos équipements.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}